â€import os
import tempfile
import asyncio
import logging
from threading import Thread
from flask import Flask
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ContextTypes,
    filters
)
import yt_dlp
from datetime import date

# ================= CONFIG =================
BOT_TOKEN = os.getenv("BOT_TOKEN")  # ENV VARIABLE
ADMIN_ID = 6449142120

DAILY_LIMIT = 5
PREMIUM_USERS = set()

# ================= USER DATA =================
user_download_count = {}
user_last_date = {}
user_language = {}

# ================= LOG =================
logging.basicConfig(level=logging.INFO)

# ================= KEEP ALIVE =================
app = Flask("")

@app.route("/")
def home():
    return "ğŸš€ Premium Downloader Bot is alive and ready!"

def run():
    app.run(host="0.0.0.0", port=8080)

def keep_alive():
    Thread(target=run, daemon=True).start()

# ================= START =================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("ğŸŒ Language", callback_data="LANG")],
        [InlineKeyboardButton("ğŸ“¢ Share Bot", switch_inline_query="Downloader Bot")]
    ]
    await update.message.reply_text(
        "ğŸ‘‹ Welcome to Premium Downloader Bot\n\n"
        "ğŸ”— Send any video link (YouTube / Shorts / TikTok / Instagram / Facebook)\n"
        "ğŸ¥ Downloads in best available quality (HD/4K where available)\n"
        "ğŸµ Audio extraction supported",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# ================= CALLBACK =================
async def callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    await q.answer()

    if q.data == "LANG":
        await q.edit_message_text(
            "Choose Language:",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("ğŸ‡§ğŸ‡© à¦¬à¦¾à¦‚à¦²à¦¾", callback_data="BN")],
                [InlineKeyboardButton("ğŸ‡ºğŸ‡¸ English", callback_data="EN")]
            ])
        )
    elif q.data in ["BN", "EN"]:
        user_language[q.from_user.id] = q.data
        await q.edit_message_text("âœ… Language Updated")

# ================= ADMIN =================
async def stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_ID:
        await update.message.reply_text("âŒ Not authorized")
        return

    await update.message.reply_text(
        f"ğŸ‘¥ Total Users: {len(user_download_count)}\n"
        f"â­ Premium Users: {len(PREMIUM_USERS)}"
    )

# ================= DOWNLOAD =================
def download_media_sync(url):
    temp = tempfile.NamedTemporaryFile(delete=False, suffix=".mp4")
    temp.close()

    ydl_opts = {
        "outtmpl": temp.name,
        "quiet": True,
        "format": "bestvideo+bestaudio/best",
        "merge_output_format": "mp4",
        "noplaylist": True,
        "ignoreerrors": True,
        "retries": 3,
        "no_warnings": True,
        "progress_hooks": []
    }

    # TikTok/Instagram/FB special handling
    if "tiktok.com" in url or "instagram.com" in url or "fb.watch" in url:
        ydl_opts["merge_output_format"] = "mp4"

    with yt_dlp.YoutubeDL(ydl_opts) as ydl:
        ydl.download([url])

    if not os.path.exists(temp.name):
        raise Exception("Download failed or video not available.")
    return temp.name

async def download_media(url):
    loop = asyncio.get_event_loop()
    return await loop.run_in_executor(None, download_media_sync, url)

# ================= MESSAGE HANDLER =================
async def handle(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid = update.effective_user.id
    text = (update.message.text or "").strip()

    if not text.startswith("http"):
        await update.message.reply_text("âŒ Please send a valid video link")
        return

    today = date.today()
    if uid not in user_last_date or user_last_date[uid] != today:
        user_last_date[uid] = today
        user_download_count[uid] = 0

    if uid not in PREMIUM_USERS:
        if user_download_count[uid] >= DAILY_LIMIT:
            await update.message.reply_text(
                "ğŸš« Daily limit reached\nâ­ Upgrade to Premium"
            )
            return
        user_download_count[uid] += 1

    msg = await update.message.reply_text("â³ Downloading your video, please wait...")

    try:
        file_path = await download_media(text)
        with open(file_path, "rb") as f:
            await update.message.reply_video(
                video=f,
                caption="âœ… Download Complete"
            )
        os.remove(file_path)
        await msg.delete()

    except Exception as e:
        await msg.edit_text(f"âŒ Failed to download video:\n{str(e)}")

# ================= MAIN =================
def main():
    keep_alive()

    app_bot = ApplicationBuilder().token(BOT_TOKEN).build()

    app_bot.add_handler(CommandHandler("start", start))
    app_bot.add_handler(CommandHandler("stats", stats))
    app_bot.add_handler(CallbackQueryHandler(callback))
    app_bot.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle))

    print("ğŸš€ Premium Downloader Bot Running")
    app_bot.run_polling()

if __name__ == "__main__":
    main()